require("dotenv").config({ path: __dirname + "/.env" });
const express = require('express');
const { twitterClient } = require("./twitterClient.js")
const { tweetSets } = require("./tweetSets.js");

let useRandomTweet = true;

const app = express();
const port = process.env.PORT || 3000;

const tweetComponents = {
    openings: [
      "üê∏ Ribbit your way to riches with Ai Frog Coin!",
      "üß†üê∏ Hop on the Ai Frog Coin train!",
      "Feeling froggy? Leap into Ai Frog Coin!",
      "Croak if you're broke! But not for long with Ai Frog Coin.",
      "Why be a prince when you can be a crypto king?",
      "üê∏ Crypto is hopping, and so should you‚Äîjoin Ai Frog Coin!",
      "Ribbit, AI, and ROI‚Äîwhat more could you ask for?",
      "Hop on over to wealth with Ai Frog Coin!",
      "The future is froggy, and it‚Äôs Ai Frog Coin!",
      "Who needs golden eggs when frogs are bringing the gold?",
      "üê∏ Leap where no frog has hopped before‚ÄîAi Frog Coin.",
      "From pond to penthouse with Ai Frog Coin!",
      "Not just AI‚ÄîAmphibious Intelligence. That's Ai Frog Coin.",
      "Join the croak chorus: Ai Frog Coin is the way forward!",
      "It‚Äôs a frog-eat-fly world, and Ai Frog Coin wins every time.",
      "Hop past the competition with the smartest frogs in crypto!",
      "Crypto evolution starts here‚ÄîAi Frog Coin!",
      "Don‚Äôt miss the lily pad‚ÄîAi Frog Coin is taking off!",
      "Ai Frog Coin: Where leaps of faith turn into leaps of wealth.",
      "Frogs are the new bulls in crypto‚ÄîAi Frog Coin is proof!",
      "üê∏ Remember, it's not a loss if you never sell‚ÄîAi Frog Coin!",
      "When one door closes, a lily pad opens: Ai Frog Coin!",
      "Why walk when you can leap to success with Ai Frog Coin?",
      "Like that frog meme, but now it‚Äôs your portfolio that‚Äôs chillin‚Äô!",
      "Feeling 'froggerish'? Hop into Ai Frog Coin!",
      "Not a financial advisor, but even Pepe‚Äôs nodding yes. üê∏",
      "Every croak tells a story‚Äîyours begins with Ai Frog Coin.",
      "Is it a bird? A plane? No‚Äîit‚Äôs Ai Frog Coin soaring high!",
      "This isn‚Äôt just a leap of faith; it‚Äôs a leap of profits.",
      "üê∏ To the moon? No, to the pond! Ai Frog Coin leads the way.",
      "Jumpstart your portfolio the froggy way‚Äîjoin Ai Frog Coin!",
      "Me, vibing: Ribbit. Also me: Ai Frog Coin just hit ATH! üöÄ",
      "Why ‚Äòhodl‚Äô when you can ‚Äòribbit‚Äô? The Ai Frog way!",
      "Hop in now‚Äînext stop, the moon pond!",
      "üê∏ If frogs could speak, they‚Äôd tell you: Invest in Ai Frog Coin.",
      "Do frogs dream of electric AI? Ours do‚Äîjoin Ai Frog Coin.",
      "Who said frogs can‚Äôt moon? Watch Ai Frog Coin prove them wrong!",
      "This is your sign: It‚Äôs time to leap into Ai Frog Coin.",
      "üê∏ Croak the talk, hop the walk‚ÄîAi Frog Coin is here.",
      "Feeling like Kermit? Be green and stack Ai Frog Coin!",
      "Ai Frog Coin: The only crypto meme that‚Äôs both smart and amphibious.",
      "Crypto advice: When in doubt, leap with Ai Frog Coin!",
      "Ever seen a frog fly? Ai Frog Coin is taking us higher!",
      "Leap like no one‚Äôs watching‚ÄîAi Frog Coin is your springboard.",
      "üê∏ What if I told you frogs could be your financial advisors?",
      "Don‚Äôt let your dreams just be memes‚Äîinvest in Ai Frog Coin.",
      "Frog Nation is calling‚Äîwill you answer? üê∏",
      "Your portfolio‚Äôs green, but is it frog-green? Hop into Ai Frog Coin!",
      "Why croak about wealth when you can ribbit into riches?",
      "It‚Äôs not just a coin; it‚Äôs a way of life‚ÄîAi Frog Coin!"
    ],
    features: [
      "Our amphibious AI is leaping over the competition.",
      "Our neural networks are as sticky as frog tongues, catching gains left and right.",
      "Our blockchain is so green, it's practically photosynthesizing.",
      "Our lily-pad ledger technology is making waves in the crypto pond.",
      "Our amphibious algorithms are predicting profits faster than a frog's tongue catches flies.",
      "Jump-start your portfolio with our smart amphibious tech.",
      "Eco-friendly, AI-smart, and amphibiously ambitious.",
      "Ai Frog Coin is revolutionizing crypto with precision leaps.",
      "Optimized AI for optimized gains‚ÄîAi Frog Coin delivers.",
      "Our lily pad staking system is a game-changer in crypto.",
      "Leap into innovation: Our AI algorithms adapt like a frog.",
      "High jump in returns, low carbon footprint‚ÄîAi Frog Coin.",
      "Amphibian tech meets AI brilliance for seamless growth.",
      "Our frogs are greener, faster, and smarter‚Äîjust like our tech.",
      "Watch your investments croak up in value with Ai Frog Coin.",
      "Advanced AI strategies for hopping past market volatility.",
      "Eco-conscious crypto with lightning-fast leaps.",
      "Lily-pad ledger innovation ensures transparency and security.",
      "Amphibious AI turning leaps of faith into consistent gains.",
      "Crypto stability you can leap on‚ÄîAi Frog Coin‚Äôs promise.",
      "Green crypto? Yes. Green returns? Absolutely.",
      "Revolutionary ledger tech, powered by AI and frog science.",
      "Forget bears and bulls‚Äîfrogs are the new trend in crypto!",
      "Our blockchain doesn‚Äôt just leap‚Äîit flies past the rest.",
      "Say goodbye to volatility, hello to amphibious AI.",
      "Photosynthesizing profits and croaking barriers: Ai Frog Coin.",
      "Neural networks as unique as each frog‚Äôs croak.",
      "Frog-powered algorithms that work while you ribbit!",
      "Leapfrog the competition with blockchain precision.",
      "Next-gen crypto evolution with a frog-green footprint.",
      "Sticky tongue profits catching opportunities in real time.",
      "Predictive AI that leaps before the market moves.",
      "Eco-friendly crypto with a bullfrog‚Äôs strength.",
      "Watch your wallet swell like a frog in monsoon.",
      "Built for speed, security, and hopping through profits.",
      "Green, amphibious, and innovative: Ai Frog Coin.",
      "Your portfolio deserves amphibious AI precision.",
      "Advanced AI? Check. Amphibian charm? Double check.",
      "Trust in frogs‚Äîour algorithms always leap forward.",
      "Our AI sees croaks where others see risks.",
      "Leapfrogging traditional investment models with style.",
      "Amphibious tech turning ponds into financial oceans.",
      "Our AI tongue grabs profits before they escape.",
      "The blockchain ecosystem reimagined‚Äîfrog style.",
      "Why stick to old tech when you can leap ahead?",
      "Our frogs don‚Äôt just ribbit‚Äîthey innovate. AI style."
    ],
    calls_to_action: [
      "Don't be a tadpole in the crypto pond - evolve with $AFC!",
      "$AFC: Where AI meets amphibian ambition!",
      "Ribbit your way to the top with $AFC!",
      "Dive in to $AFC now!",
      "Kiss your financial worries goodbye with $AFC!",
      "Leap into the future of finance with $AFC!",
      "Croak louder, earn bigger with $AFC!",
      "Catch the fly of opportunity‚Äîinvest in $AFC!",
      "Get hopping, the $AFC train is leaving!",
      "Turn your lily pad into a launch pad with $AFC!",
      "Dive into greener crypto with $AFC today!",
      "Take the leap of profit‚Äîjoin $AFC!",
      "No pond is too small to start with $AFC.",
      "Upgrade from tadpole to tycoon with $AFC!",
      "Make every hop count‚Äîinvest in $AFC!",
      "From croaks to cash flows‚Äî$AFC delivers!",
      "Join the crypto amphibian revolution with $AFC!",
      "Every frog deserves its moonshot‚Äîstart with $AFC.",
      "Stop hopping around‚Äîstick with $AFC!",
      "Leap first, croak later‚Äî$AFC is the way forward!",
      "Ribbit and relax‚Äî$AFC will do the rest!",
      "Your financial lily pad awaits‚Äîstart with $AFC!",
      "Leap where no crypto has gone before‚Äî$AFC.",
      "Why wait? Leap into $AFC and start croaking in gains!",
      "Fly-catching profits are just one leap away‚Äî$AFC!",
      "Crypto confidence that‚Äôs leaps ahead‚Äî$AFC.",
      "Don‚Äôt croak about losses‚Äîleap into $AFC.",
      "Ribbit to riches‚Äî$AFC is your launch pad.",
      "Every ribbit counts: Start investing in $AFC!",
      "Hop into a community of amphibious innovators‚Äî$AFC.",
      "Be the frog everyone croaks about‚Äîinvest in $AFC!",
      "Amphibious intelligence with real gains‚Äî$AFC.",
      "From froglets to financial wizards‚Äî$AFC makes it happen.",
      "Think big, leap big‚Äî$AFC is the frog path.",
      "Why float when you can leap ahead‚Äî$AFC today!"
    ],
    hashtags: [
      "#AiFrogCoin #Crypto #ToTheMoon üöÄ",
      "#AiFrogCoin #AICrypto #HODL",
      "#AiFrogCoin #GreenCrypto #CryptoTrading",
      "#AiFrogCoin #BlockchainTech #CryptoInvestment",
      "#AiFrogCoin #CryptoRoyalty #FinancialFreedom",
      "#AiFrogCoin #CryptoEvolution #AIRevolution",
      "#AiFrogCoin #SmartCrypto #EcoFriendly",
      "#AiFrogCoin #CryptoInnovation #TechLeap",
      "#AiFrogCoin #InvestSmarter #Crypto2024",
      "#AiFrogCoin #HODLStrong #WealthLeap",
      "#AiFrogCoin #AltCoinKing #GreenFuture",
      "#AiFrogCoin #BlockchainAI #CryptoBoom",
      "#AiFrogCoin #AmphibianTech #SmartInvesting",
      "#AiFrogCoin #EcoCrypto #AIProfit",
      "#AiFrogCoin #CryptoLeap #WealthJourney",
      "#AiFrogCoin #DigitalGold #CryptoAI",
      "#AiFrogCoin #HopToIt #AIBlock",
      "#AiFrogCoin #SustainableCrypto #CryptoKing",
      "#AiFrogCoin #AILeap #SmartBlockchain",
      "#AiFrogCoin #LeapAhead #CryptoInvesting"
    ]
  };  

function generateRandomTweet() {
  const opening = tweetComponents.openings[Math.floor(Math.random() * tweetComponents.openings.length)];
  const feature = tweetComponents.features[Math.floor(Math.random() * tweetComponents.features.length)];
  const callToAction = tweetComponents.calls_to_action[Math.floor(Math.random() * tweetComponents.calls_to_action.length)];
  const hashtags = tweetComponents.hashtags[Math.floor(Math.random() * tweetComponents.hashtags.length)];

  return `${opening} ${feature} ${callToAction} ${hashtags}`;
}

function generateRandomTweetSet() {
    const tweetSet = tweetSets[Math.floor(Math.random() * tweetSets.length)];
    console.log("Generated tweet set:", tweetSet);
    return tweetSet.join(" ");
}

const tweet = async () => {
    try {
        if (global.remainingRequests <= 0) {
            const now = Date.now() / 1000;
            if (now < global.resetTime) {
                const waitTime = global.resetTime - now;
                console.log(`Rate limit exceeded. Waiting ${waitTime} seconds.`);
                await new Promise(resolve => setTimeout(resolve, waitTime * 1000));
            }
        }
        const tweetContent = useRandomTweet ? generateRandomTweet() : generateRandomTweetSet();
        useRandomTweet = !useRandomTweet;
        console.log("Attempting to send tweet:", tweetContent);
        const response = await twitterClient.v2.tweet(tweetContent);

        global.remainingRequests = parseInt(response.rateLimit.remaining);
        global.resetTime = parseInt(response.rateLimit.reset);
        console.log("Tweet sent successfully:", tweetContent);
        return { success: true, message: "Tweet sent successfully", content: tweetContent };
    } catch (e) {
        console.error("Error sending tweet:", e);
        console.error("Error details:", JSON.stringify(e, null, 2));

        if (e.rateLimit) {
            global.remainingRequests = parseInt(e.rateLimit.remaining);
            global.resetTime = parseInt(e.rateLimit.reset);
        }
        return { success: false, message: "Error sending tweet", error: e.message, details: JSON.stringify(e, null, 2) };
    }
}

global.remainingRequests = 17;
global.resetTime = Date.now() / 1000 + 86400;

app.get('/healthcheck', (req, res) => {
  res.status(200).json({ status: 'OK', message: 'Server is running' });
});

app.get('/', async (req, res) => {
    try {
        const result = await tweet();
        res.send(`
            <html>
                <body>
                    <h1>Twitter Bot</h1>
                    <div id="result">${result.message}</div>
                    <div id="details">${result.details || ''}</div>
                    <script>
                        console.log('Tweet content:', ${JSON.stringify(result.content)});
                    </script>
                </body>
            </html>
        `);
    } catch (error) {
        console.error("Unexpected error:", error);
        res.status(500).send("An unexpected error occurred");
    }
});


const domain = process.env.DOMAIN || 'localhost';
app.listen(port, () => {
    console.log(`Server running at http://${domain}:${port}`);
});
